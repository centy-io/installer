#!/usr/bin/env node

"use strict";

const { spawnSync } = require("child_process");
const path = require("path");

const PLATFORMS = {
  "darwin arm64": "@centy-io/centy-installer-darwin-arm64",
  "darwin x64": "@centy-io/centy-installer-darwin-x64",
  "linux arm64": "@centy-io/centy-installer-linux-arm64",
  "linux x64": "@centy-io/centy-installer-linux-x64",
  "win32 x64": "@centy-io/centy-installer-win32-x64",
};

const key = `${process.platform} ${process.arch}`;
const pkg = PLATFORMS[key];

if (!pkg) {
  console.error(
    `Unsupported platform: ${process.platform} ${process.arch}\n` +
      `Supported: ${Object.keys(PLATFORMS).join(", ")}`,
  );
  process.exit(1);
}

const binName =
  process.platform === "win32" ? "centy-installer.exe" : "centy-installer";

let binPath;
try {
  binPath = path.join(
    path.dirname(require.resolve(`${pkg}/package.json`)),
    "bin",
    binName,
  );
} catch {
  console.error(
    `Could not find package ${pkg}.\n` +
      `This usually means the optional dependency was not installed.\n` +
      `Try reinstalling with: npm install @centy-io/centy-installer`,
  );
  process.exit(1);
}

const result = spawnSync(binPath, process.argv.slice(2), {
  stdio: "inherit",
});

if (result.error) {
  console.error(`Failed to run ${binPath}: ${result.error.message}`);
  process.exit(1);
}

process.exit(result.status === null ? 1 : result.status);
